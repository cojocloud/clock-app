name: Build & Deploy Clock App

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - README.md
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/clock-app

jobs:
  # ------------------------------------------------------
  # Build & Push Docker Image (with Semantic Versioning)
  # ------------------------------------------------------
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute Docker tags
        id: tags
        run: |
          REF=${GITHUB_REF#refs/*/}

          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${REF#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)

            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:v${VERSION}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:v${MAJOR}.${MINOR}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:v${MAJOR}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

          elif [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
            echo "tags=${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT

          else
            echo "tags=${IMAGE_NAME}:develop" >> $GITHUB_OUTPUT
          fi

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.tags.outputs.tags }}

  # ------------------------
  # Deploy to Staging EC2
  # ------------------------

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
    steps:
      - name: Deploy to Staging EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_NAME: docker.io/thiexco/clock-app:develop
          EC2_HOST: ${{ secrets.EC2_STAGING_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        with:
          host: ${{ secrets.EC2_STAGING_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DOCKER_USERNAME,DOCKER_PASSWORD,IMAGE_NAME
          script: |
            echo "üöÄ Deploying to Staging EC2: $EC2_HOST"

            # Docker login
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

            # Pull develop image
            docker pull $IMAGE_NAME

            # Stop & remove old container
            docker stop clock-app-staging || true
            docker rm clock-app-staging || true

            # Run new container
            docker run -d \
              --name clock-app-staging \
              --restart unless-stopped \
              -p 8080:80 \
              $IMAGE_NAME

            # Cleanup old images
            docker image prune -af --filter "until=24h"

            # Health check
            sleep 5
            if [ "$(docker ps -q -f name=clock-app-staging)" ]; then
              echo "‚úÖ Container is running"
            else
              echo "‚ùå Container failed to start"
              docker logs clock-app-staging
              exit 1
            fi


  # -------------------------
  # Deploy to Production EC2
  # -------------------------
  # Production deploy
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # - name: Configure AWS credentials (if needed for role assumption)
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Production EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_NAME: docker.io/thiexco/clock-app:latest
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DOCKER_USERNAME,DOCKER_PASSWORD,IMAGE_NAME
          script: |
            echo "üöÄ Deploying to Production EC2: $EC2_HOST"

            # Docker login
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

            # Pull latest image
            docker pull $IMAGE_NAME

            # Stop & remove old container
            docker stop clock-app || true
            docker rm clock-app || true

            # Run new container
            docker run -d \
              --name clock-app \
              --restart unless-stopped \
              -p 8080:80 \
              $IMAGE_NAME

            # Cleanup old images
            docker image prune -af --filter "until=24h"

            # Health check
            sleep 5
            if [ "$(docker ps -q -f name=clock-app)" ]; then
              echo "‚úÖ Container is running"
            else
              echo "‚ùå Container failed to start"
              docker logs clock-app
              exit 1
            fi