name: Build & Deploy Clock App

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - README.md
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/clock-app

jobs:
  # ------------------------------------------------------
  # Build & Push Docker Image (with Semantic Versioning)
  # ------------------------------------------------------
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute Docker tags
        id: tags
        run: |
          REF=${GITHUB_REF#refs/*/}

          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${REF#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)

            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:v${VERSION}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:v${MAJOR}.${MINOR}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:v${MAJOR}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

          elif [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
            echo "tags=${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT

          else
            echo "tags=${IMAGE_NAME}:develop" >> $GITHUB_OUTPUT
          fi

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.tags.outputs.tags }}

  # ------------------------
  # Deploy to Staging EC2
  # ------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'

    environment:
      name: staging
      url: http://${{ secrets.EC2_STAGING_HOST }}

    steps:
      - name: Deploy to staging
        uses: appleboy/ssh-action@v1.0.0
        env:
          IMAGE: ${{ env.IMAGE_NAME }}:develop
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ secrets.EC2_STAGING_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: IMAGE,DOCKER_USER,DOCKER_PASS
          script: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker pull $IMAGE

            docker stop clock-app-staging || true
            docker rm clock-app-staging || true

            docker run -d \
              --name clock-app-staging \
              --restart unless-stopped \
              -p 8080:80 \
              $IMAGE
            docker image prune -af --filter "until=24h"

  # -------------------------
  # Deploy to Production EC2
  # -------------------------
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    environment:
      name: production
      url: http://${{ secrets.EC2_HOST }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          IMAGE: ${{ env.IMAGE_NAME }}:latest
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: IMAGE,DOCKER_USER,DOCKER_PASS
          script: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker pull $IMAGE

            docker stop clock-app || true
            docker rm clock-app || true

            docker run -d \
              --name clock-app \
              --restart unless-stopped \
              -p 8080:80 \
              $IMAGE

            docker image prune -af --filter "until=24h"
